# KMP 算法

## 求 next 数组

对于 ababaaa 的 next 数组

- 先找部分匹配值 PM 

PM（部分匹配值）就是最长「前缀 = 后缀」的长度。
逐个来：

* i=1 (`a`) → pm=0
* i=2 (`ab`) → pm=0
* i=3 (`aba`) → pm=1
* i=4 (`abab`) → pm=2
* i=5 (`ababa`) → pm=3
* i=6 (`ababaa`) → pm=1
* i=7 (`ababaaa`) → pm=1


| 编号 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
|----|---|---|---|---|---|---|---|
| S  | a | b | a | b | a | a | a |
| pm | 0 | 0 | 1 | 2 | 3 | 1 | 1 |  

- 整体右移一位，低位用 -1 填充，若题给条件首位为0，则全部+1

| 编号       | 1  | 2 | 3 | 4 | 5 | 6 | 7 |
|----------|----|---|---|---|---|---|---|
| S        | a  | b | a | b | a | a | a |
| pm       | 0  | 0 | 1 | 2 | 3 | 1 | 1 |  
| next(+1) | 0  | 1 | 1 | 2 | 3 | 4 | 2 |
| next     | -1 | 0 | 0 | 1 | 2 | 3 | 1 |


## 比对次数

主串T = a b a b a b b a a b a b a a a

子串S = a b a b a a a 

| 编号  | 1   | 2 | 3 | 4 | 5 | 6   | 7    | 8 | 9    | 10 | 11 | 12 | 13 | 14 | 15 |
|-----|-----|---|---|---|---|-----|------|---|------|----|----|----|----|----|----|
| 主 串 | a   | b | a | b | a | b   | b    | a | a    | b  | a  | b  | a  | a  | a  |
| 第一次 | (a) | b | a | b | a | a*  | a    |   |      |    |    |    |    |    |    |
| 第二次 |     |   | a | b | a | (b) | a*   | a | a    |    |    |    |    |    |    |
| 第三次 |     |   |   |   | a | b   | (a)* | b | a    | a  | a  |    |    |    |    |
| 第四次 |     |   |   |   |   | a   | (b)  | a | b*   | a  | a  | a  |    |    |    |
| 第五次 |     |   |   |   |   |     |      | a | (b)* | a  | b  | a  | a  | a  |    |
| 第六次 |     |   |   |   |   |     |      |   | a    | b  | a  | b  | a  | a  | a  |

第一次滑动：主串第 6 个字符，子串第 6 个字符出现分歧（比对 6 次）

子串移动到 next[6-1]+1 = 4，继续对比主串第 6 个字符。

第二次滑动：主串第 7 个字符，子串第 5 个字符出现分歧（比对 2 次）

子串移动到 next[5-1]+1 = 3，继续比对主串第 7 个字符。

第三次滑动：主串第 7 个字符，子串第 3 个字符出现分歧（比对 1 次）

子串移动到 next[3-1]+1 = 2，继续比对第 8 个字符

第四次滑动：主串第 9 个字符，子串第 4 个字符出现分歧（比对 1 次）

子串移动到 next[4-1]+1 = 2，继续对比第 9 个字符

第五次滑动：主串第 9 个字符，子串第 2 个字符出现分歧（比对 1 次）

子串移动到 next[2-1] + 1 = 1, 继续对比第 9 个字符。

第六次滑动：7 次全中（比对 7 次）

共比对 6+2+1+1+1+7 = 18 次

# KMP 算法的优化

关键点：若匹配失败的字符和下一个匹配字符相等，则必然匹配失败。

优化方案：若 sub_string[next[i]] == sub_string[i],则next[i] = next[next[i]]。

例如：
对于串 a b a b a a a:

| 编号         | 0  | 1 | 2  | 3 | 4  | 5 | 6 |
|------------|----|---|----|---|----|---|---|
| str        | a  | b | a  | b | a  | a | a |
| next[i]    | -1 | 0 | 0  | 1 | 2  | 3 | 1 |
| nextval[i] | -1 | 0 | -1 | 0 | -1 | 3 | 1 |

str[0] = a;   
str[next[0]] = /

str[1] = b;   
str[next[1]] = str[0] = a;

str[2] = a;
str[next[2]] = str[0] = a;   
相等，故 nextval[2] = nextval[0] = -1;

str[3] = b;   
str[next[3]] = str[1] = b;
相等，故 nextval[3] = nextval[1] = 0;

